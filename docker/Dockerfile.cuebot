# -----------------
# CACHE
# -----------------
FROM gradle:6.0.1-jdk11 AS cache

USER gradle

# First line after FROM should be unique to avoid --cache-from weirdness.
RUN echo "Cuebot cache stage"

RUN mkdir -p /home/gradle/cache_home
ENV GRADLE_USER_HOME /home/gradle/cache_home

# Only copy dependency-related files
COPY --chown=gradle:gradle ./cuebot/build.gradle /home/gradle/cuebot/
COPY --chown=gradle:gradle ./cuebot/settings.gradle /home/gradle/cuebot/

WORKDIR /home/gradle/cuebot

# Only download dependencies
# Eat the expected build failure since no source code has been copied yet
RUN gradle clean build --no-deamon > /dev/null 2>&1 || true

# -----------------
# BUILD
# -----------------
FROM gradle:6.0.1-jdk11 AS build

USER gradle

# First line after FROM should be unique to avoid --cache-from weirdness.
RUN echo "Cuebot build stage"

COPY --chown=gradle:gradle ./cuebot /home/gradle/cuebot/
COPY --chown=gradle:gradle ./proto /home/gradle/proto/
COPY --chown=gradle:gradle --from=cache /home/gradle/cache_home /home/gradle/.gradle

WORKDIR /home/gradle/cuebot

RUN gradle build --stacktrace

COPY --chown=gradle:gradle VERSION.in VERSIO[N] ./
RUN test -e VERSION || echo "$(cat VERSION.in)-custom" | tee VERSION
RUN mv ./build/libs/cuebot.jar ./build/libs/cuebot-$(cat ./VERSION)-all.jar


# -----------------
# RPM
# -----------------
FROM jc21/rpmbuild-centos7:latest AS rpm

# Random first line after from

USER rpmbuilder

RUN echo "Cuebot RPM Stage"

COPY --chown=rpmbuilder:rpmbuilder LICENSE ./

COPY --from=build \
        --chown=rpmbuilder:rpmbuilder \
        /home/gradle/cuebot/VERSION \
        /home/gradle/cuebot/build/libs/cuebot-*-all.jar \
        /home/gradle/cuebot/deploy/systemd/opencue-cuebot.service \
        /home/gradle/cuebot/deploy/opencue-cuebot \
        /home/gradle/cuebot/packaging/rpm/cuebot.spec \
        /home/gradle/cuebot/packaging/rpm/create_rpm.sh \
        ./

RUN chmod +x create_rpm.sh && ./create_rpm.sh cuebot "$(cat VERSION)"


# -----------------
# RUN
# -----------------
FROM openjdk:11-jre-slim-buster

# First line after FROM should be unique to avoid --cache-from weirdness.
RUN echo "Cuebot runtime stage"

ARG CUEBOT_GRPC_CUE_PORT=8443
ARG CUEBOT_GRPC_RQD_PORT=8444
ARG CUEBOT_GRPC_DEBUG_PORT=8450

COPY ./docker/etc/client.truststore.jks /etc/security/ssl

WORKDIR /opt/opencue

COPY --from=build /home/gradle/cuebot/build/libs/cuebot-*-all.jar ./
COPY --from=rpm /home/rpmbuilder/rpmbuild/RPMS/noarch/opencue-cuebot-*.noarch.rpm ./

RUN ln -s $(ls ./cuebot-*-all.jar) ./cuebot-latest.jar

# TODO(bcipriano) Implement a new GRPC-based health check.
# https://github.com/imageworks/OpenCue/issues/73
# HEALTHCHECK --start-period=30s --timeout=5s CMD python check_ice.py localhost CueStatic 9019

VOLUME ["/opt/opencue/logs"]

ENV grpc_cue_port ${CUEBOT_GRPC_CUE_PORT}
ENV grpc_rqd_port ${CUEBOT_GRPC_RQD_PORT}

EXPOSE $grpc_cue_port

ENTRYPOINT ["java"]

CMD [ "-jar", "/opt/opencue/cuebot-latest.jar" ]
